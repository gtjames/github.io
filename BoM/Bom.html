<style>
    table {
        border-collapse: collapse;
        width: 80%;
    }

.hideMe { display: none;  }
.showMe { display: block; text-shadow: 0.1em 0.1em 0.15em #333 }

td, th {
    border: 1px solid;
    padding: 8px;
    text-shadow: 0.1em 0.1em 0.15em #333
}
th  {
	background-color: AntiqueWhite;        
	text-align: center;
}

    tr:nth-child(odd)   {   background-color: Bisque;      }
    tr:nth-child(even)  {   background-color: Wheat;      }
    .ATOZ, .ZTOA        {   background-color: Cornsilk     }
    .special            {   background-color: Linen    }

</style>

Highlight these words: <input type="text" id="special" noHistory=true/>
<span id="addHighlighting">    <button>Add Highlighting to:</button> </span>
<p>
<span class="readBook">    <button>Read the Book of Mormon</button> </span>
<table style='border-syle: none;'>
	<TR  style='background-color:white;'>
		<TD width="35%">
			<div id="frequency">
				<TABLE id='wordList'>
					<TR>
        				<th>Order</th>
        				<th>Frequency</th>
        				<th>Word</th>
        			</TR>
        		</table>
        	</div>
		</TD>
		<TD   valign="top" width="15%">
			<div id='references'>		</div>
		</TD>
		<TD   valign="top" width="25%">
			<div id='words' class='ShowMe' >
				<table id='highLightList'>
					<TR>
						<th onclick='deleteWord()'  width="40%"><a href='#'>Highlight</a></th>
					</TR>
				</table>
			</div>
			<div id="verse" class=hideMe></div>
		</TD>
	</TR>
</table>

<script>
    var lines;
    var	fileLoaded = false;
    var allWords = {};
    var specialWords = [];

    document.getElementById('addHighlighting').addEventListener( 'click', function(evt) { addHighLighting(document.getElementById('special').value); }, false);
    document.querySelector('.readBook'       ).addEventListener( 'click', function(evt) { readBlob(); }, false);
	
	function showReferences(evt) {
        var hoverWord = evt.target.textContent;
		var ul = "<ul>";
			ul += "<strong><big> " + hoverWord + "</big></strong>";
		for ( r = 0; r < allWords[hoverWord].ref.length; r++)
			ul += "<li class='showVerse'>" + allWords[hoverWord].ref[r];
		ul += "</ul>";
		document.getElementById('references').innerHTML = ul;
		
 	    var x = document.getElementsByClassName('showVerse' );
 		for (var i = 0; i < x.length; i++) {
 			x[i].addEventListener( 'mouseover', function(evt) { showVerse(hoverWord, evt.target.innerText); }, false);
 	    	x[i].addEventListener( 'mouseout',  function(evt) { hideVerse(evt); }, false);
 		}
	}
	
	function showVerse (word, verseRef) {
		var verse = localStorage.getItem(verseRef);
		verse = verse.replace(new RegExp("\\b " + word + "\\b","gi"), "<strong><big> " + word + "</big></strong>");
        document.getElementById('verse').innerHTML = verse;
		document.getElementById('words').className = 'hideMe';
		document.getElementById('verse').className = 'showMe';
	}
	function hideVerse(evt) {
		document.getElementById('words').className = 'showMe';
		document.getElementById('verse').className = 'hideMe';
	}
	
	function addHighLighting(highLightedWord) {

		var newWords = highLightedWord.split(' ');
		
		for ( i = 0; i < newWords.length; i++ ) {
			var newWord = newWords[i];
			if (newWord.length == 0) 					continue;
			if ( specialWords.indexOf(newWord) > -1)	continue;

			specialWords.push(newWord);
			var table = document.getElementById('highLightList');

			var row = table.insertRow( table.rows.length );
			var oCell = row.insertCell(0)
			oCell.innerHTML = "<label><input type='checkbox'>" + newWord + "</label>"
		}
		if (fileLoaded)
			hightLightSpecialWords();
	}

	function deleteWord() {
		var table = document.getElementById('highLightList');
		var rowCount = table.rows.length;

		for(var i=1; i<rowCount; i++) {
			var row = table.rows[i];
			if(! row.firstChild.firstChild.firstChild.checked )		continue;
			var foundAt = specialWords.indexOf(row.firstChild.firstChild.textContent);
			if ( foundAt == -1)										continue;
			specialWords.splice(foundAt,1);
			table.deleteRow(i);
			rowCount--;
			i--;
		}

		if (fileLoaded)
			hightLightSpecialWords();
	}
	
	function hightLightSpecialWords() {
		var table = document.getElementById("wordList");
        var tbody = table.tBodies.item(0);

		for (var i = 1, row; row = table.rows[i]; i++) {
   			//iterate through rows
   			//rows would be accessed using the "row" variable assigned in the for loop
			var className = isSpecial( row.cells[2].innerText, specialWords );
 			row.cells[0].className = className;
 			row.cells[1].className = className;
 			row.cells[2].className = className;
 			if (className.length > 0) {
                var row = tbody.rows.item(i);
                tbody.deleteRow(i);
                tbody.insertBefore(row, tbody.rows.item(1));
  			}
   		}
	}
		
    function readBlob() {
		var xmlhttp = new XMLHttpRequest();
		var url = "TheBookOfMormon.txt";

		xmlhttp.onreadystatechange=function()
		{
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				readTheBook(xmlhttp.responseText);
			}
		}
		xmlhttp.open("GET", url, true);
		xmlhttp.send();
	}

	function readTheBook(theBook) {
	    allWords = {};

        lines = theBook.split("\n");
        /*
        THE BOOK OF MORMON
        An Account Written by THE HAND OF MORMON UPON PLATES TAKEN FROM THE PLATES OF NEPHI
        Wherefore, it is an abridgment of the record of the people of Nephi, and also of the Lamanites--Written to the Lamanites, who are a remnant of the house of Israel; and also to Jew and Gentile--Written by way of commandment, and also by the spirit of prophecy and of revelation--Written and sealed up, and hid up unto the Lord, that they might not be destroyed--To come forth by the gift and power of God unto the interpretation thereof--Sealed by the hand of Moroni, and hid up unto the Lord, to come forth in due time by way of the Gentile--The interpretation thereof by the gift of God.
        An abridgment taken from the Book of Ether also, which is a record of the people of Jared, who were scattered at the time the Lord confounded the language of the people, when they were building a tower to get to heaven--Which is to show unto the remnant of the House of Israel what great things the Lord hath done for their fathers; and that they may know the covenants of the Lord, that they are not cast off forever--And also to the convincing of the Jew and Gentile that JESUS is the CHRIST, the ETERNAL GOD, manifesting himself unto all nations--And now, if there are faults they are the mistakes of men; wherefore, condemn not the things of God, that ye may be found spotless at the judgment-seat of Christ.
        1 Nephi THE FIRST BOOK OF NEPHI HIS REIGN AND MINISTRY An account of Lehi and his wife Sariah and his four sons, being called, (beginning at the eldest) Laman, Lemuel, Sam, and Nephi. The Lord warns Lehi to depart out of the land of Jerusalem, because he prophesieth unto the people concerning their iniquity and they seek to destroy his life. He taketh three days' journey into the wilderness with his family. Nephi taketh his brethren and returneth to the land of Jerusalem after the record of the Jews. The account of their sufferings. They take the daughters of Ishmael to wife. They take their families and depart into the wilderness. Their sufferings and afflictions in the wilderness. The course of their travels. They come to the large waters. Nephi's brethren rebel against him. He confoundeth them, and buildeth a ship. They call the name of the place Bountiful. They cross the large waters into the promised land, and so forth. This is according to the account of Nephi; or in other words, I, Nephi, wrote this record.
        1 Nephi 1 Chapter 1
        1 Nephi 1:1  1 I, Nephi, having been born of goodly parents, therefore I was taught somewhat in all the learning of my father; and having seen many afflictions in the course of my days, nevertheless, having been highly favored of the Lord in all my days; yea, having had a great knowledge of the goodness and the mysteries of God, therefore I make a record of my proceedings in my days.
        1 Nephi 1:2  2 Yea, I make a record in the language of my father, which consists of the learning of the Jews and the language of the Egyptians.
        1 Nephi 1:3  3 And I know that the record which I make is true; and I make it with mine own hand; and I make it according to my knowledge.
        1 Nephi 1:4  4 For it came to pass in the commencement of the first year of the reign of Zedekiah, king of Judah, (my father, Lehi, having dwelt at Jerusalem in all his days); and in that same year there came many prophets, prophesying unto the people that they must repent, or the great city Jerusalem must be destroyed.
        */
        for (var l = 0; l < lines.length; l++) {
            if (startOfBook(lines[l])) {
            	console.log(lines[l]);
				var bookName = getBookName(lines[l]);
				for (l++; l < lines.length && !startOfBook(lines[l]); l++) {
                	if (lines[l].search('Chapter') >= 0)
                    	l++;
     	        	tallyWords(removeChapterRef(lines[l]), lines[l]);
            	}
            	if (l < lines.length && startOfBook(lines[l])) l--;
        //    	if (l > 50 ) break;
        	}
    	}

        var tableList = "<TABLE id='wordList'><TR>" +
        	"<th onclick='callSort(this, 0)'><a href='#'>Order</a></th>" +
        	"<th onclick='callSort(this, 1)'><a href='#'>Frequency</a></th>" +
        	"<th onclick='callSort(this, 2)'><a href='#'>Word</a></th>" +
        	"</TR>";
    	var row = 1;
        for (var word in allWords) {
        	tableList += "<TR>"+
                	        "<TD>" + row++ + "</TD>"+
                    	    "<TD>" + allWords[word].count + "</TD>"+
                            "<TD name='showReferences'>" + word  + "</TD>"+
                	    "</TR>";
        }
        document.getElementById('frequency').innerHTML = tableList + "</TABLE>";
        fileLoaded = true;
		hightLightSpecialWords();
 	    var x = document.getElementsByName('showReferences' );
 		for (var i = 0; i < x.length; i++) {
 			x[i].addEventListener( 'mouseover', function(evt) { showReferences(evt); }, false);
 		}
    }

	function getBookName(line) {
		var bookName = line.split(' ')[0];
		if ( bookName.length == 1 )		bookName += ' Nephi';
		else if (bookName == 'Words')	bookName += ' of Mormon';
		else if (bookName == 'THE')		bookName  =  'The Book of Mormon-Introduction';
		return bookName;
	}

    function isSpecial(word, specialWords) {
        for (var s = 0; s < specialWords.length; s++)
            if (specialWords[s] == word) 
            	return 'special';
        return '';
    }

    function removeChapterRef(line, chapter) {
    	var book;
        var reference = line.split(":");
        var words;
        line = line.toLowerCase();
    	book = reference[0];
        line = line.slice(reference[0].length + 1, -1);
        words = line.split(/\W/);
    	book += ':' + words[0];
        words = words.slice(3);

        return {"words": words, "chapter":book};
    }

    function tallyWords(wordsAndRef, line) {
    	var words = wordsAndRef.words;
    	localStorage.setItem(wordsAndRef.chapter, line);
        for (var w = 0; w < words.length; w++) {
            if (words[w].length == 0)
                continue;
            if (typeof allWords[words[w]]  !== 'undefined') {
            	allWords[words[w]].count += 1;
            	if (allWords[words[w]].ref.indexOf(wordsAndRef.chapter) == -1)
				    allWords[words[w]].ref.push( wordsAndRef.chapter );
            }
            else {
            	allWords[words[w]] = { "count": 1, "ref":[wordsAndRef.chapter]};
			}
        }
    }

    function startOfBook(line) {
        return (line.search('BOOK OF') >= 0 || line.search('WORDS OF') >= 0);
    }

    var lastSortCol = null;

    function callSort(ele, column) {
        ele.className = (ele.className == "ATOZ" || ele.className.length==0) ? "ZTOA" : "ATOZ";
        if (lastSortCol !== null && lastSortCol !== ele)
            lastSortCol.className = "";
        lastSortCol = ele;
        return sort_table_rows('wordList', column, (ele.className == "ATOZ") ? 1 : -1)
    }

    var is_number_pattern = /^\d+(\.\d+)?$/;
    /* Column 0 is the first column */
    function sort_table_rows(id, column_number, sortOrder) {

        function sort_by_chosen_column(a, b) {
            /* Fetch the text from the row, excluding spaces */
            a = a.cells.item(column_number);
            a = (a.innerText || a.textContent);
            a = a.replace(/^\s+/, "").replace(/\s+$/, "");

            b = b.cells.item(column_number);
            b = (b.innerText || b.textContent);
            b = b.replace(/^\s+/, "").replace(/\s+$/, "");

            /* Special handling for numbers */
            if (a.match(is_number_pattern) && b.match(is_number_pattern)) return (parseFloat(a) - parseFloat(b)) * sortOrder;

            /* All the rest is alphabetical order */
            else if (a < b) return -1 * sortOrder;
            else if (a > b) return 1 * sortOrder;
            else return 0;
        }
        
        var table = document.getElementById(id);
        /*
         * To skip the header, ask for the tbodies. You actually can have
         * more than one.
         */
        for (var i = 0; i < table.tBodies.length; i++) {
            var tbody = table.tBodies.item(i);
            /* Move into an array */
            var rows = [];
            while (tbody.rows.length > 1) {
                rows.push(tbody.rows.item(1));
                tbody.deleteRow(1);
            }
            /* Sort the array */
            rows = rows.sort(sort_by_chosen_column);
            /* Move back out */
            while (rows.length > 0)
                tbody.appendChild(rows.shift());
        }
        return false;
    }
</script>
